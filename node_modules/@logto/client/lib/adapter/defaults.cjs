'use strict';

var js = require('@logto/js');
var jose = require('jose');

const defaultClockTolerance = 300; // 5 minutes
const verifyIdToken = async (idToken, clientId, issuer, jwks, clockTolerance = defaultClockTolerance) => {
    const result = await jose.jwtVerify(idToken, jwks, { audience: clientId, issuer, clockTolerance });
    if (Math.abs((result.payload.iat ?? 0) - Date.now() / 1000) > clockTolerance) {
        throw new js.LogtoError('id_token.invalid_iat');
    }
};
class DefaultJwtVerifier {
    constructor(client, clockTolerance = defaultClockTolerance) {
        this.client = client;
        this.clockTolerance = clockTolerance;
    }
    async verifyIdToken(idToken) {
        const { appId } = this.client.logtoConfig;
        const { issuer, jwksUri } = await this.client.getOidcConfig();
        this.getJwtVerifyGetKey ||= jose.createRemoteJWKSet(new URL(jwksUri));
        await verifyIdToken(idToken, appId, issuer, this.getJwtVerifyGetKey, this.clockTolerance);
    }
}

exports.DefaultJwtVerifier = DefaultJwtVerifier;
exports.defaultClockTolerance = defaultClockTolerance;
exports.verifyIdToken = verifyIdToken;
